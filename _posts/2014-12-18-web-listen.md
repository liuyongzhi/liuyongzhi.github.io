---
layout: post
category: "Web应用程序监视,小企业构建集群方案"
title:  "小企业构建集群方案及如何选择标准Web应用程序监视工具"
tags: [Web应用程序监视,小企业构建集群方案]
---  
##一、小企业构建集群方案  
网站架构的变迁：[http://my.oschina.net/duxuefeng/blog/34101](http://my.oschina.net/duxuefeng/blog/34101)

如果网站要部署负载均衡高可用的Linux集群方案，而公司又想用最节省成本的方式来实施的话，一般需要几台服务器呢？
	
	我的回答是四台，即2+2架构，
	（1）、最前面是二台Nginx/HAProxy+Keeplaived机器，
	（2）、后面是二台配置比较好的Web机器，
	（3）、MySQL数据库采用一主一从的方式，分别放在二台Web机器上，
	（4）、监控的Nagios部署在从Nginx/HAProxy机器上，
	（5）、流量监控我一般放主Nginx/HAProxy，软件采用的是MRTG+Nload的方式，
	（6）、服务器之间的数据同步我采用的是rsync+inotify的方法，
	当然更多时候，我采用的是纯rsync方式，这样是避免 网站有大文件发生改动的时候会产生频繁读盘的麻烦;
	当然了，如果大家的公司对文件服务器有更高要求的时候(比如图片类型的)，我们可以考虑再增加二台服务器，
		做成DRBD+Heartbeat+NFS的方式;
	如果有海量文件需要存储的话，我们可以考虑用MFS，当然这样也是比较耗机器的。

像类似以上的小公司集群架构里，我们是如何解决session同步的问题呢？

	我们可以采用Nginx的ip_hash和HAProxy的 balance source机制，它们的原理比较类似，都会让某一客户机在相当长的一段时间内只访问固定的后端的某台真实的Web服务器，这样会话就会得以保持，我们在网站页面进行login的时候，就不会在二台Web服务器之间跳来跳去了，自然也不会出现登陆一次后网站又提醒你没有登陆，需要重新登陆的情况。

另外，小公司的Web服务器我们至少有二种选择：
	
	一种是Apache，另一种是Nginx，
	（1）、在流量和并发不大的环境下，我们完全可以选择 Apache作为我们的Web服务器，虽然它的抗并发能力不高，
		但它的稳定性是最好的，我的许多电子商务网站都是基于Apache;
	（2）、而大流量大并发的环境，我比较倾向于Nginx。

MySQL在这里我用的就是一主一从的设计，虽然很多朋友觉得这种设计比较简单，但事实证明，它也最稳定的。我的电子商务网站也是采用这种架 构,几年下来，从没有因为数据库的故障发生过丢单现象，网站上线的前期阶段，我们可以通过PHP程序，把后台的查询功能的入口选择Slave机器，这样可 以大大减少主数据库的压力;另外，从MySQL机器并非仅仅只起一个备份和备机的作用，我们完全通过PHP程序将后台的复杂查询转到从MySQL机器上。 当然了，MySQL的主从复制状态监控也是非常重要的，我一般是通过Nagios和SHELL脚本双监控的方式。

##二、最可靠的Web应用监控程序是什么?我们应该用什么标准来比较呢?
	
	（1）、监视Web服务器资源(CPU/内存利用率、存储等)
	（2）、监视Web应用的可用性和响应性
	（3）、检测异常，如安全扫描、潜在黑客或拒绝服务攻击
	（4）、用于市场营销目的页面加载、点击率追踪等等

每个用途都有专门的工具选择，但目前貌似还没有单个工具执行以上所有的功能。可以试试**Nagios、CloudFlare或Google分析**。

在继续深入选择Web应用监控工具之前，请考虑下面的问题：
	
	用户(例如行政管理、市场营销等等)最终想要该工具做什么?
	预期的细节级别和报告的类型是什么?
	你的Web应用平台运行IIS或Apache这些常见的Web应用吗?你有定制代码吗?应用是定制的，不能访问源代码?这样的话，应用难以监控。
	你有为商业产品做预算吗，或者开源和免费的应用(如谷歌)都可以负担得起吗?

最后，向预期的供应商咨询。告诉他们你的情况和期望，看看是否有匹配产品。不要害怕问一些尖锐的问题，可以引用一些在你的工作领域里比较理想的公司。